{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}Mapa de Repartidores Activos{% endblock %}

{% block extrastyle %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
    .map-container {
        margin: 20px 0;
    }

    #map {
        height: 600px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        border: 1px solid #ddd;
    }

    .stats-bar {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    .stat-box {
        background: white;
        padding: 15px 25px;
        border-radius: 6px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        border-left: 4px solid #417690;
    }

    .stat-box strong {
        display: block;
        font-size: 24px;
        color: #417690;
        margin-bottom: 5px;
    }

    .stat-box span {
        font-size: 13px;
        color: #666;
    }

    .legend {
        background: white;
        padding: 15px;
        border-radius: 6px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        margin-bottom: 20px;
        display: flex;
        gap: 20px;
        align-items: center;
        flex-wrap: wrap;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
    }

    .legend-dot {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        border: 2px solid white;
        box-shadow: 0 1px 3px rgba(0,0,0,0.3);
    }

    .legend-dot.disponible { background: #22c55e; }
    .legend-dot.ocupado { background: #3b82f6; }
    .legend-dot.fuera_servicio { background: #ef4444; }

    .update-info {
        text-align: center;
        color: #666;
        font-size: 13px;
        margin-top: 10px;
        font-style: italic;
    }

    /* Custom marker styles */
    .custom-marker {
        background: none;
        border: none;
    }

    /* Popup personalizado */
    .leaflet-popup-content {
        margin: 10px;
        line-height: 1.6;
    }

    .popup-title {
        font-size: 16px;
        font-weight: bold;
        margin-bottom: 8px;
        color: #333;
    }

    .popup-badge {
        display: inline-block;
        padding: 3px 10px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
        color: white;
        margin: 5px 0;
    }

    .popup-badge.disponible { background: #22c55e; }
    .popup-badge.ocupado { background: #3b82f6; }
    .popup-badge.fuera_servicio { background: #ef4444; }

    @media (max-width: 768px) {
        #map {
            height: 400px;
        }

        .stats-bar {
            flex-direction: column;
        }
    }
</style>
{% endblock %}

{% block content %}
<h1>üó∫Ô∏è Mapa de Repartidores Activos</h1>
<p>Visualizaci√≥n en tiempo real de todos los repartidores activos y verificados.</p>

<!-- Estad√≠sticas -->
<div class="stats-bar">
    <div class="stat-box">
        <strong>{{ total_repartidores }}</strong>
        <span>Total Repartidores</span>
    </div>
    <div class="stat-box" style="border-left-color: #22c55e;">
        <strong id="stat-disponibles">-</strong>
        <span>Disponibles</span>
    </div>
    <div class="stat-box" style="border-left-color: #3b82f6;">
        <strong id="stat-ocupados">-</strong>
        <span>Ocupados</span>
    </div>
    <div class="stat-box" style="border-left-color: #ef4444;">
        <strong id="stat-fuera">-</strong>
        <span>Fuera de Servicio</span>
    </div>
</div>

<!-- Leyenda -->
<div class="legend">
    <strong>Leyenda:</strong>
    <div class="legend-item">
        <span class="legend-dot disponible"></span>
        Disponible
    </div>
    <div class="legend-item">
        <span class="legend-dot ocupado"></span>
        Ocupado
    </div>
    <div class="legend-item">
        <span class="legend-dot fuera_servicio"></span>
        Fuera de Servicio
    </div>
</div>

<!-- Mapa -->
<div class="map-container">
    <div id="map"></div>
    <div class="update-info">
        üîÑ El mapa se actualiza autom√°ticamente cada 30 segundos
        <br>
        <span id="ultima-actualizacion">√öltima actualizaci√≥n: Cargando...</span>
    </div>
</div>

<!-- Datos JSON embebidos -->
<script id="data-json" type="application/json">
{{ repartidores|safe }}
</script>
{% endblock %}

{% block extrajs %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
(function() {
    let map = null;
    let markers = [];
    let repartidoresData = [];

    // Colores seg√∫n estado
    const COLORES = {
        'disponible': '#22c55e',
        'ocupado': '#3b82f6',
        'fuera_servicio': '#ef4444'
    };

    // Inicializar mapa
    function initMap() {
        try {
            // Crear mapa centrado en Ecuador
            map = L.map('map').setView([-1.05, -78.5], 7);

            // Agregar capa de tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 18,
                minZoom: 6
            }).addTo(map);

            // Cargar datos iniciales
            cargarRepartidores();

            // Actualizar cada 30 segundos
            setInterval(cargarRepartidores, 30000);

        } catch (error) {
            console.error('Error al inicializar mapa:', error);
        }
    }

    // Cargar datos de repartidores
    function cargarRepartidores() {
        try {
            const scriptTag = document.getElementById('data-json');
            if (!scriptTag) {
                console.error('No se encontr√≥ el script con datos JSON');
                return;
            }

            repartidoresData = JSON.parse(scriptTag.textContent);
            actualizarMapa(repartidoresData);
            actualizarEstadisticas(repartidoresData);
            actualizarTimestamp();

        } catch (error) {
            console.error('Error al cargar repartidores:', error);
        }
    }

    // Actualizar marcadores en el mapa
    function actualizarMapa(repartidores) {
        // Limpiar marcadores existentes
        markers.forEach(marker => map.removeLayer(marker));
        markers = [];

        // Agregar nuevos marcadores
        repartidores.forEach(rep => {
            if (!rep.latitud || !rep.longitud) return;

            const color = COLORES[rep.estado] || '#6b7280';

            // Crear icono personalizado
            const icon = L.divIcon({
                className: 'custom-marker',
                html: `
                    <div style="
                        width: 24px;
                        height: 24px;
                        background: ${color};
                        border: 3px solid white;
                        border-radius: 50%;
                        box-shadow: 0 2px 6px rgba(0,0,0,0.4);
                    "></div>
                `,
                iconSize: [24, 24],
                iconAnchor: [12, 12]
            });

            // Crear marcador
            const marker = L.marker([rep.latitud, rep.longitud], { icon });

            // Construir popup
            const nombre = `${rep.user__first_name || ''} ${rep.user__last_name || ''}`.trim() || 'Sin nombre';
            const estadoDisplay = rep.estado.replace('_', ' ');
            const calificacion = rep.calificacion_promedio ? parseFloat(rep.calificacion_promedio).toFixed(1) : 'N/A';

            marker.bindPopup(`
                <div style="min-width: 180px;">
                    <div class="popup-title">${nombre}</div>
                    <span class="popup-badge ${rep.estado}">${estadoDisplay}</span>
                    <div style="margin-top: 10px; font-size: 13px;">
                        <div>‚≠ê Calificaci√≥n: <strong>${calificacion}/5.0</strong></div>
                        <div style="margin-top: 5px; color: #666;">
                            üìç ${rep.latitud.toFixed(5)}, ${rep.longitud.toFixed(5)}
                        </div>
                        <div style="margin-top: 8px;">
                            <a href="https://maps.google.com/?q=${rep.latitud},${rep.longitud}"
                               target="_blank"
                               style="color: #417690; text-decoration: none; font-size: 12px;">
                                üó∫Ô∏è Ver en Google Maps ‚Üí
                            </a>
                        </div>
                    </div>
                </div>
            `);

            marker.addTo(map);
            markers.push(marker);
        });

        // Ajustar vista si hay marcadores
        if (markers.length > 0) {
            const group = L.featureGroup(markers);
            map.fitBounds(group.getBounds().pad(0.1));
        }
    }

    // Actualizar estad√≠sticas
    function actualizarEstadisticas(repartidores) {
        const stats = {
            disponible: 0,
            ocupado: 0,
            fuera_servicio: 0
        };

        repartidores.forEach(rep => {
            if (stats.hasOwnProperty(rep.estado)) {
                stats[rep.estado]++;
            }
        });

        document.getElementById('stat-disponibles').textContent = stats.disponible;
        document.getElementById('stat-ocupados').textContent = stats.ocupado;
        document.getElementById('stat-fuera').textContent = stats.fuera_servicio;
    }

    // Actualizar timestamp
    function actualizarTimestamp() {
        const now = new Date();
        const timeString = now.toLocaleTimeString('es-EC', {
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
        const dateString = now.toLocaleDateString('es-EC');

        document.getElementById('ultima-actualizacion').textContent =
            `√öltima actualizaci√≥n: ${dateString} ${timeString}`;
    }

    // Inicializar cuando el DOM est√© listo
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initMap);
    } else {
        initMap();
    }
})();
</script>
{% endblock %}
